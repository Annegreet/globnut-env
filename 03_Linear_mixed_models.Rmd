---
title: "N-dep effect on vegetation indices"
author: "Annegreet Veeken"
date: "`r Sys.Date()`"
output:
  word_document: default
params: 
  data: "outputs/02_GlobNut_subsampled.rds"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	fig.height = 4,
	fig.width = 4,
	message = FALSE,
	warning = FALSE,
	include = FALSE
)
## Load packages
if(!require(tidyverse)) install.packages("tidyverse")
if(!require(vegan)) install.packages("vegan")
if(!require(easystats)) install.packages("easystats")
if(!require(lme4)) install.packages("lme4")
if(!require(knitr)) install.packages("knitr")
if(!require(scales)) install.packages("scales")
if(!require(gridExtra)) install.packages("gridExtra")
if(!require(MuMIn)) install.packages("MuMIn")
if(!require(cowplot)) install.packages("cowplot")

## Load data
globnut <- readRDS(params$data) %>% ungroup() %>% 
    filter(!lim == "No limitation by N, P, K") %>% 
   dplyr::filter(between(lat, 35, 75)) %>% 
  dplyr::filter(between(lon, -25, 150)) %>% 
  mutate(soil_age = factor(soil_age, levels = c("1", "2", "3")),
         lith_simp = factor(lith_simp, levels = c("acid", "intermediate",
                                                  "well-buffered")))  %>% 
  drop_na %>% 
  mutate(N_biomass = N * biomass,
         P_biomass = P * biomass,
         ndep = log(ndep*10), # to g/ha en log
         ndep_cent = ndep - mean(ndep),
         MAP = log(MAP),
         NP = log(NP),
         MAP_cent = MAP - mean(MAP),
         PET_cent = PET - mean(PET),
         MAT_cent = MAT - mean(MAT),
         NP_cent = NP - mean(NP),
         biomass_cent = biomass - mean(biomass),
         lim = as.factor(lim)) 

# global model
fm <- "MAT_cent + I(MAT_cent^2) + MAP_cent + I(MAP_cent^2) + PET_cent + I(PET_cent^2) + ndep_cent + I(ndep_cent^2)  + NP_cent + I(NP_cent^2)"

# Define subset criteria for model selection: quadratic terms can only be included if linear terms are included as well
sb <- expression(dc(MAT_cent, `I(MAT_cent^2)`) && dc(MAP_cent,`I(MAP_cent^2)`) && 
                   dc(PET_cent,`I(PET_cent^2)`)  && dc(biomass_cent,`I(biomass_cent^2)`) && 
                   dc(ndep_cent, `I(ndep_cent^2)`) && dc(`lim:ndep_cent`, `I(ndep_cent^2):lim`))
sb <- expression(MAT_cent & MAP_cent & PET_cent & NP_cent & ndep_cent)

colours <- brewer_pal(palette = "GnBu")(5) %>% rev()
colours_lim <- c('#1b9e77','#d95f02','#7570b3')
names(colours) <- c("clim", "geo", "ndep", "random", "lim")

# cor(globnut[, c("MAT", "MAP", "PET", "ndep")]) %>% kable()
```

## Biomass

```{r fig.height=8, fig.width=7, include=FALSE}
full_model_biomass <- lmer(formula(paste("log(biomass) ~", fm, 
                                         "+ (1|cell)")), 
                           data = globnut, 
                           na.action = "na.fail")
check_model(full_model_biomass)

check_heteroscedasticity(full_model_biomass)
check_outliers(full_model_biomass)
check_collinearity(full_model_biomass)

# Generate all possible model combinations
model_combinations <- dredge(full_model_biomass, subset = sb)

# get top model
fm_biomass <- formula(get.models(model_combinations, subset = 1)[[1]])

best_model_biomass <- lmer(fm_biomass, data = globnut)
check_model(best_model_biomass)

check_heteroscedasticity(best_model_biomass)
check_outliers(best_model_biomass)
check_collinearity(best_model_biomass)
```

```{r}
# plot terms
biomass_limits <- c(0, 600) 
cdl <- ggeffects::ggpredict(best_model_biomass, terms = c("ndep_cent [0.57]")) %>% 
  mutate(x = exp(x + mean(globnut$ndep))/1000) %>% drop_na()
vert <- data.frame(x = cdl$x, xend = cdl$x, y = cdl$predicted, yend = 0, group = cdl$group)  
horz <- data.frame(x = cdl$x, xend = 0, y = cdl$predicted, yend = cdl$predicted, group = cdl$group)  

# nutrients
(biomass_ndep <- ggeffects::ggpredict(best_model_biomass,
                                 terms = c("ndep_cent [all]")) %>% 
    ggplot(aes(x = exp(x + mean(globnut$ndep))/1000, y = predicted)) +
      geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .5) +
      geom_line(linewidth = 1) +
    geom_segment(data = vert, aes(x = x, y = y, yend = yend, xend = xend),linetype = "dashed") +
    geom_segment(data = horz, aes(x = x, y = y, yend = yend, xend = xend),linetype = "dashed") + 
    scale_y_continuous(Biomass~(g/m^2), limits = biomass_limits) +
    scale_x_continuous("5-year cumulative\nN-deposition (kg/ha)", trans = "log",
                       breaks = c(5,10,25,50,100,300),
                       labels = c(5,10,25,50,100,300)) +
  theme_bw() +
  theme(legend.title = element_blank()))

# climate 
(biomass_mat <- ggeffects::ggpredict(best_model_biomass, terms = "MAT_cent [all]") %>%
  ggplot(aes(x = x + mean(globnut$MAT), y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("Biomass (g/m2)",limits = biomass_limits) +
  xlab("MAT (Â°C)") +
  theme_bw())

(biomass_map <- ggeffects::ggpredict(best_model_biomass, terms = "MAP_cent [all]") %>%
  ggplot(aes(x = exp(x +mean(globnut$MAP)), y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("biomass (g/m2)",limits = biomass_limits) +
  xlab("MAP (mm/yr)") +
  theme_bw())
(biomass_pet <- ggeffects::ggpredict(best_model_biomass, terms = "PET_cent [all]") %>% 
  ggplot(aes(x = x + mean(globnut$PET), y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("biomass (g/m2)",limits = biomass_limits) +
  xlab("PET (mm/yr)") +  
  theme_bw())

# background annotation of np plot
lim_anno <- data.frame(xmin = c(-Inf,10,16),
                       xmax = c(10,16,Inf),
                       ymin = -Inf,
                       ymax = Inf,
                       lim = c("N-limitation", 
                               "Co-limitation N-P","P-limitation"))
biomass_np_pred <- ggeffects::ggpredict(best_model_biomass,
                                 terms = c("NP_cent [all]"))

(biomass_np <- ggplot() +
  geom_rect(data = lim_anno, aes(xmin = xmin, xmax = xmax, ymin = ymin, 
                                 ymax = ymax, fill = lim), alpha = 0.2) +
      geom_ribbon(data = biomass_np_pred, 
                  aes(x = exp(x + mean(globnut$NP)), ymin = conf.low, ymax = conf.high), alpha = .5) +
      geom_line(data = biomass_np_pred, aes(x = exp(x + mean(globnut$NP)), 
                                       y = predicted), linewidth = 1) +
    scale_x_continuous("N:P",limits = c(0,40)) +
    scale_y_continuous(Biomass~(g/m^2), limits = biomass_limits) +
    scale_fill_manual(values = colours_lim)+
    theme_bw() + 
    theme(legend.title = element_blank()))

```

## Species richness

```{r echo=FALSE, fig.height=8, fig.width=7}
full_model_richness <- lmer(formula(paste("log(spec_ric) ~", "log(plot_size) +", fm, "+ (1|cell)")),
                           data = globnut,
                           na.action = "na.fail")
check_model(full_model_richness)
check_collinearity(full_model_richness)
check_outliers(full_model_biomass)

# Generate all possible model combinations
model_combinations_richness <- dredge(full_model_richness, subset = sb)

# get top model
fm_richness <- formula(get.models(model_combinations_richness, subset = 1)[[1]])
best_model_richness <- lmer(fm_richness,
                           data = globnut,
                           na.action = "na.fail")
check_model(best_model_richness)
check_heteroscedasticity(best_model_richness)
check_collinearity(best_model_richness)
check_outliers(best_model_richness)

model_parameters(best_model_richness) %>% plot
```

```{r}
# plot terms
richness_limits <- c(0, 60) 
# species richness at critical deposition of 15 kg/ha/y (*5)
cdl_cent <- log(75000)-mean(globnut$ndep) # log and center
cdl <- ggeffects::ggpredict(best_model_richness, terms = c("ndep_cent [0.57]")) %>% 
  mutate(x = exp(x + mean(globnut$ndep))/1000) %>% drop_na()
vert <- data.frame(x = cdl$x, xend = cdl$x, y = cdl$predicted, yend = 0, group = cdl$group)  
horz <- data.frame(x = cdl$x, xend = 0, y = cdl$predicted, yend = cdl$predicted, group = cdl$group)  

# nutrients
(richness_ndep_lim <- ggeffects::ggpredict(best_model_richness, terms = c("ndep_cent [all]")) %>% 
  ggplot(aes(x = exp(x + mean(globnut$ndep))/1000, y = predicted)) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .5) +
    geom_line(linewidth = 1) +
    # geom_point(aes(x = exp(x + mean(globnut$ndep))/1000, y=1)) +
  scale_y_continuous("Species richness (q0)", limits = richness_limits) +
  scale_x_continuous("5-year cumulative\nN-deposition (kg/ha)", trans = "log",
                       breaks = c(5,10,25,50,100,300),
                       labels = c(5,10,25,50,100,300)) +
    
  geom_segment(data = vert, aes(x = x, y = y, yend = yend, xend = xend),linetype = "dashed") + 
  geom_segment(data = horz, aes(x = x, y = y, yend = yend, xend = xend),linetype = "dashed") + 
  theme_bw() +
  theme(legend.title = element_blank()))
(richness_plotsize <- ggeffects::ggpredict(best_model_richness, terms = "plot_size [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["ndep"]) +
    geom_line(colour = colours["ndep"], linewidth = 1) +
  scale_y_continuous("Species richness",limits = richness_limits) +
  xlab("Plot size") +
  theme_bw())
# Climate
(richness_pet <- ggeffects::ggpredict(best_model_richness, terms = "PET_cent [all]") %>% 
  ggplot(aes(x = x + mean(globnut$PET), y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("Species richness",limits = richness_limits) +
  xlab("PET (mm/yr)") +  
  theme_bw())
(richness_map <- ggeffects::ggpredict(best_model_richness, terms = "MAP_cent [all]") %>% 
  ggplot(aes(x = exp(x + mean(globnut$MAP)), y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("Species richness",limits = richness_limits) +
  xlab("MAP (mm/yr)") +  
  theme_bw())
(richness_mat <- ggeffects::ggpredict(best_model_richness, terms = "MAT_cent [all]") %>% 
  ggplot(aes(x = x + mean(globnut$MAT), y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("Species richness",limits = richness_limits) +
  xlab("MAT (C)") +  
  theme_bw())

richness_np_pred <- ggeffects::ggpredict(best_model_richness,
                                 terms = c("NP_cent [all]"))

(richness_np <- ggplot() +
  geom_rect(data = lim_anno, aes(xmin = xmin, xmax = xmax, ymin = ymin, 
                                 ymax = ymax, fill = lim), alpha = 0.2) +
      geom_ribbon(data = richness_np_pred, 
                  aes(x = exp(x + mean(globnut$NP)), ymin = conf.low, 
                      ymax = conf.high), alpha = .5) +
      geom_line(data = richness_np_pred, aes(x = exp(x + mean(globnut$NP)), 
                                       y = predicted), linewidth = 1) +
    scale_x_continuous("N:P",limits = c(0,40)) +
    scale_y_continuous("Species richness (q0)", limits = richness_limits) +
    scale_fill_manual(values = colours_lim)+
    theme_bw() + 
    theme(legend.title = element_blank(),
          legend.position = "none"))

model_parameters(best_model_richness)
```

## Species diversity (q1)

```{r echo=FALSE, fig.height=8, fig.width=7}
full_model_q1 <- lmer(formula(paste("log(q1) ~", fm, "+ log(plot_size) + (1|cell)")), 
                              data = globnut, 
                           na.action = "na.fail")
windows();check_model(full_model_q1)

check_heteroscedasticity(full_model_q1)
check_outliers(full_model_q1)
check_collinearity(full_model_q1)

# Generate all possible model combinations
model_combinations_q1 <- dredge(full_model_q1, subset = sb)

# get top model
fm_q1 <- formula(get.models(model_combinations_q1, 
                                 subset = 1)[[1]])
best_model_q1 <- lmer(fm_q1, data = globnut)
windows();check_model(best_model_q1)

check_heteroscedasticity(best_model_q1)
check_outliers(best_model_q1)
check_collinearity(best_model_q1)
```

```{r}
# plot terms
q1_limits <- c(0, 15)
cdl <- ggeffects::ggpredict(best_model_q1, terms = c("ndep_cent [0.57]")) %>% 
  mutate(x = exp(x + mean(globnut$ndep))/1000) %>% drop_na()
vert <- data.frame(x = cdl$x, xend = cdl$x, y = cdl$predicted, yend = 0, group = cdl$group)  
horz <- data.frame(x = cdl$x, xend = 0, y = cdl$predicted, yend = cdl$predicted, group = cdl$group)  

# nutrients
(q1_ndep_lim <- ggeffects::ggpredict(best_model_q1,
                                 terms = c("ndep_cent [all]")) %>% 
    ggplot(aes(x = exp(x + mean(globnut$ndep))/1000, y = predicted)) +
      geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .5) +
      geom_line(linewidth = 1) +
    scale_color_manual(values = colours_lim) +
    scale_fill_manual(values = colours_lim) +
     geom_segment(data = vert, aes(x = x, y = y, yend = yend, xend = xend),linetype = "dashed") + 
  geom_segment(data = horz, aes(x = x, y = y, yend = yend, xend = xend),linetype = "dashed") + 
    scale_y_continuous("ENS (q1)", limits = q1_limits) +
    scale_x_continuous("5-year cumulative\nN-deposition (kg/ha)", trans = "log",
                       breaks = c(5,10,25,50,100,300),
                       labels = c(5,10,25,50,100,300)) +
  theme_bw() +
  theme(legend.title = element_blank()))
# climate 
(q1_mat <- ggeffects::ggpredict(best_model_q1, terms = "MAT_cent [all]") %>%
  ggplot(aes(x = x + mean(globnut$MAT), y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("ENS (q1)",limits = q1_limits) +
  xlab("MAT (Â°C)") +
  theme_bw())
(q1_pet <- ggeffects::ggpredict(best_model_q1, terms = "MAT_cent [all]") %>%
  ggplot(aes(x = x + mean(globnut$MAT), y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("ENS (q1)",limits = q1_limits) +
  xlab("PET (mm/yr)") +
  theme_bw())
(q1_map <- ggeffects::ggpredict(best_model_q1, terms = "MAP_cent [all]") %>% 
  ggplot(aes(x = exp(x + mean(globnut$MAP)), y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("ENS (q1)",limits = q1_limits) +
  xlab("MAP (mm/yr)") +  
  theme_bw())

q1_np_pred <- ggeffects::ggpredict(best_model_q1,
                                 terms = c("NP_cent [all]"))

(q1_np <- ggplot() +
  geom_rect(data = lim_anno, aes(xmin = xmin, xmax = xmax, ymin = ymin, 
                                 ymax = ymax, fill = lim), alpha = 0.2) +
      geom_ribbon(data = q1_np_pred, 
                  aes(x = exp(x + mean(globnut$NP)), ymin = conf.low, 
                      ymax = conf.high), alpha = .5) +
      geom_line(data = q1_np_pred, aes(x = exp(x + mean(globnut$NP)), 
                                       y = predicted), linewidth = 1) +
    scale_x_continuous("N:P",limits = c(0,40)) +
    scale_y_continuous("ENS (q1)", limits = q1_limits) +
    scale_fill_manual(values = colours_lim)+
    theme_bw() + 
    theme(legend.title = element_blank(),
          legend.position = "none"))

model_parameters(best_model_q1) 
```

## Species diversity (q2)

```{r echo=FALSE, fig.height=8, fig.width=7}
full_model_q2 <- lmer(formula(paste("log(q2) ~", fm, " + log(plot_size) + (1|cell)")), 
                      data = globnut, 
                           na.action = "na.fail")
windows();check_model(full_model_q2)

check_heteroscedasticity(full_model_q2)
check_outliers(full_model_q2)
check_collinearity(full_model_q2)

# Generate all possible model combinations
model_combinations_q2 <- dredge(full_model_q2, subset = sb)

# get top model
fm_q2 <- formula(get.models(model_combinations_q2, 
                                 subset = 1)[[1]])
best_model_q2 <- lmer(fm_q2, data = globnut)

windows();check_model(best_model_q2)
check_heteroscedasticity(best_model_q2)
check_outliers(best_model_q2)
check_collinearity(best_model_q2)
```

```{r}
# plot terms
q2_limits <- c(0, 8) 
cdl <- ggeffects::ggpredict(best_model_q2, terms = c("ndep_cent [0.57]")) %>% 
  mutate(x = exp(x + mean(globnut$ndep))/1000) %>% drop_na()
vert <- data.frame(x = cdl$x, xend = cdl$x, y = cdl$predicted, yend = 0, group = cdl$group)  
horz <- data.frame(x = cdl$x, xend = 0, y = cdl$predicted, yend = cdl$predicted, group = cdl$group)  

# nutrients
(q2_ndep_lim <- ggeffects::ggpredict(best_model_q2,
                                 terms = c("ndep_cent [all]")) %>% 
    ggplot(aes(x = exp(x + mean(globnut$ndep))/1000, y = predicted)) +
      geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .5) +
      geom_line(linewidth = 1) +
     geom_segment(data = vert, aes(x = x, y = y, yend = yend, xend = xend),linetype = "dashed") + 
  geom_segment(data = horz, aes(x = x, y = y, yend = yend, xend = xend),linetype = "dashed") + 
    scale_y_continuous("ENS (q2)", limits = q2_limits) +
    scale_x_continuous("5-year cumulative\nN-deposition (kg/ha)", trans = "log",
                       breaks = c(5,10,25,50,100,300),
                       labels = c(5,10,25,50,100,300)) +
  theme_bw() +
  theme(legend.title = element_blank()))

# climate 
(q2_mat <- ggeffects::ggpredict(best_model_q2, terms = "MAT_cent [all]") %>%
  ggplot(aes(x = x + mean(globnut$MAT), y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("ENS (q2)",limits = q2_limits) +
  xlab("MAT (Â°C)") +
  theme_bw())
(q2_map <- ggeffects::ggpredict(best_model_q2, terms = "MAP_cent [all]") %>% 
  ggplot(aes(x = exp(x + mean(globnut$MAP)), y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("ENS (q2)",limits = q2_limits) +
  xlab("MAP (mm/yr)") +  
  theme_bw())

q2_np_pred <- ggeffects::ggpredict(best_model_q2,
                                 terms = c("NP_cent [all]"))

(q2_np <- ggplot() +
  geom_rect(data = lim_anno, aes(xmin = xmin, xmax = xmax, ymin = ymin, 
                                 ymax = ymax, fill = lim), alpha = 0.2) +
      geom_ribbon(data = q2_np_pred, 
                  aes(x = exp(x + mean(globnut$NP)), ymin = conf.low, 
                      ymax = conf.high), alpha = .5) +
      geom_line(data = q2_np_pred, aes(x = exp(x + mean(globnut$NP)), 
                                       y = predicted), linewidth = 1) +
    scale_x_continuous("N:P",limits = c(0,40)) +
    scale_y_continuous("ENS (q2)", limits = q2_limits) +
    scale_fill_manual(values = colours_lim) +
    theme_bw() + 
    theme(legend.title = element_blank(),
          legend.position = "none"))


model_parameters(best_model_q2)
```

## Plots

```{r echo=FALSE, include=TRUE, fig.width = 8, fig.height = 4, dpi = 300}
leg <- get_legend(biomass_np + theme(legend.position = "bottom"))
ndep_lim1 <- biomass_ndep + theme(legend.position = "none")
ndep_lim2 <- richness_ndep_lim + theme(legend.position = "none") 
ndep_lim3 <- q1_ndep_lim + theme(legend.position = "none")
ndep_lim4 <- q2_ndep_lim + theme(legend.position = "none")
np_lim1 <- biomass_np + theme(legend.position = "none")
np_lim2 <- richness_np + theme(legend.position = "none") 
np_lim3 <- q1_np + theme(legend.position = "none")
np_lim4 <- q2_np + theme(legend.position = "none")

# g <- grid.arrange(ndep_lim1, ndep_lim2, ndep_lim3, ndep_lim4, leg,
#              layout_matrix = rbind(c(1,2),
#                                  c(3,4),
#                                  c(5,5)), heights = c(3,3.1,1))

g <- grid.arrange(ndep_lim1, ndep_lim2, ndep_lim3, ndep_lim4, 
                  np_lim1, np_lim2, np_lim3, np_lim4, leg,
             layout_matrix = rbind(c(1,2,3,4),
                                 c(5,6,7,8),
                                  c(NA,9,9,NA)), heights = c(3,3,0.5))


ggsave("figures/fig2_ndep_lim.png", g, height = 4.5, width = 8, dpi = 300)

```

# Supplementary

## Model parameters

```{r echo=FALSE, include=TRUE}
model_parameters(best_model_biomass) %>% 
  mutate(across(where(is.numeric), ~round(., digits = 4))) %>% 
  filter(!Parameter == "(Intercept)") %>% 
   filter(!str_detect(Parameter, "SD")) %>% 
  mutate(Parameter = str_remove(Parameter, "lith_simp|lim|_cent") %>% 
           str_remove("I\\(") %>% str_remove( "\\)"),
         Parameter = case_when(Parameter == "ndep" ~ "N-deposition (log)",
                               Parameter == "ndep^2" ~ "N-deposition^2 (log)",
                               Parameter == "MAP" ~ "MAP (log)",
                               TRUE ~ Parameter),
         p = case_when(p < 0.001 ~ "<0.001",
                       TRUE ~ as.character(p)),
         SE = as.character(SE)) %>% 
  as_tibble() %>% 
  dplyr::select(-CI, -CI_low, -CI_high, -df_error, -t, -Group, -Effects) %>% 
  add_row(Parameter = c("Conditional R2", "Marginal R2"),
          Coefficient = c(round(r2(best_model_biomass)$R2_conditional, 3),
                          round(r2(best_model_biomass)$R2_marginal,3))) %>%
  replace_na(list(Coefficient = "-", SE = "", p = "")) %>% 
  kable(caption = "Model output biomass")

model_parameters(best_model_richness) %>% 
  mutate(across(where(is.numeric), ~round(., digits = 4))) %>% 
  filter(!Parameter == "(Intercept)") %>% 
  filter(!str_detect(Parameter, "SD")) %>% 
  mutate(Parameter = str_remove(Parameter, "lith_simp|lim|_cent") %>% 
           str_remove("I\\(") %>% str_remove( "\\)"),
         Parameter = case_when(Parameter == "ndep" ~ "N-deposition (log)",
                               Parameter == "ndep^2" ~ "N-deposition^2 (log)",
                               Parameter == "log(plot_size" ~ "plot_size (log)",
                               Parameter == "MAP" ~ "MAP (log)",
                               TRUE ~ Parameter),
         p = case_when(p < 0.001 ~ "<0.001",
                       TRUE ~ as.character(p)),
         SE = as.character(SE)) %>% 
  as_tibble() %>% 
  dplyr::select(-CI, -CI_low, -CI_high, -df_error, -t, -Group, -Effects) %>% 
  add_row(Parameter = c("Conditional R2", "Marginal R2"),
          Coefficient = c(round(r2(best_model_richness)$R2_conditional, 3),
                          round(r2(best_model_richness)$R2_marginal,3))) %>%
  replace_na(list(Coefficient = "-", SE = "", p = "")) %>% 
  kable(caption = "Model output Species richness")
  

model_parameters(best_model_q1) %>% 
  mutate(across(where(is.numeric), ~round(., digits = 4))) %>% 
  filter(!Parameter == "(Intercept)") %>% 
  filter(!str_detect(Parameter, "SD")) %>% 
  mutate(Parameter = str_remove(Parameter, "lith_simp|lim|_cent") %>% 
           str_remove("I\\(") %>% str_remove( "\\)"),
         Parameter = case_when(Parameter == "ndep" ~ "N-deposition (log)",
                               Parameter == "ndep^2" ~ "N-deposition^2 (log)",
                               Parameter == "log(plot_size" ~ "plot_size (log)",
                               Parameter == "MAP" ~ "MAP (log)",
                               TRUE ~ Parameter),
         p = case_when(p < 0.001 ~ "<0.001",
                       TRUE ~ as.character(p)),
         SE = as.character(SE)) %>% 
  as_tibble() %>% 
  dplyr::select(-CI, -CI_low, -CI_high, -df_error, -t, -Group, -Effects) %>% 
  add_row(Parameter = c("Conditional R2", "Marginal R2"),
          Coefficient = c(round(r2(best_model_q1)$R2_conditional, 3),
                          round(r2(best_model_q1)$R2_marginal,3))) %>%
  replace_na(list(Coefficient = "-", SE = "", p = "")) %>% 
  kable(caption = "Model output q1")

model_parameters(best_model_q2) %>% 
  mutate(across(where(is.numeric), ~round(., digits = 4))) %>% 
  filter(!Parameter == "(Intercept)") %>% 
  filter(!str_detect(Parameter, "SD")) %>% 
  mutate(Parameter = str_remove(Parameter, "lith_simp|lim|_cent") %>% 
           str_remove("I\\(") %>% str_remove( "\\)"),
         Parameter = case_when(Parameter == "ndep" ~ "N-deposition (log)",
                               Parameter == "ndep^2" ~ "N-deposition^2 (log)",
                               Parameter == "log(plot_size" ~ "plot_size (log)",
                               Parameter == "MAP" ~ "MAP (log)",
                               TRUE ~ Parameter),
         p = case_when(p < 0.001 ~ "<0.001",
                       TRUE ~ as.character(p)),
         SE = as.character(SE)) %>% 
  as_tibble() %>% 
  dplyr::select(-CI, -CI_low, -CI_high, -df_error, -t, -Group, -Effects) %>% 
  add_row(Parameter = c("Conditional R2", "Marginal R2"),
          Coefficient = c(round(r2(best_model_q2)$R2_conditional, 3),
                          round(r2(best_model_q2)$R2_marginal,3))) %>%
  replace_na(list(Coefficient = "-", SE = "", p = "")) %>% 
  kable(caption = "Model output q2")

```


## Model selection

```{r echo=FALSE}
## biomass
# Create a table with the model formula, AIC, and delta AIC
model_table <- cbind(Formula = get.models(model_combinations, subset = TRUE) %>% 
                       map(., ~formula(., fixed.only = TRUE)),
                      AIC = round(model_combinations$AICc, 2),
                      Delta_AIC = round(model_combinations$delta, 2)) %>% 
  as.data.frame(row.names = NULL) 

# Create a table in R Markdown format
kable(model_table, row.names = FALSE)

compare_performance(get.models(model_combinations, subset = 1:10)) %>% kable


## Richness
# Create a table with the model formula, AIC, and delta AIC
model_table_richness <- cbind(Formula = get.models(model_combinations_richness, subset = TRUE) %>% 
                       map(., ~formula(., fixed.only = TRUE)),
                      AIC = round(model_combinations_richness$AICc, 2),
                      Delta_AIC = round(model_combinations_richness$delta, 2)) %>% 
  as.data.frame(row.names = NULL)

# Create a table in R Markdown format
kable(model_table_richness, row.names = FALSE)

compare_performance(get.models(model_combinations_richness, subset = 1:10)) 


## q1
# Create a table with the model formula, AIC, and delta AIC
model_table_q1 <- cbind(Formula = get.models(model_combinations_q1, subset = TRUE) %>% 
                       map(., ~formula(., fixed.only = TRUE)),
                      AIC = round(model_combinations_q1$AICc, 2),
                      Delta_AIC = round(model_combinations_q1$delta, 2)) %>% 
  as.data.frame(row.names = NULL) 


# Create a table in R Markdown format
kable(model_tableq1, row.names = FALSE)

compare_performance(get.models(model_combinations_q1, subset = 1:10)) 


## q2
# Create a table with the model formula, AIC, and delta AIC
model_table_q2 <- cbind(Formula = get.models(model_combinations_q2, subset = TRUE) %>% 
                       map(., ~formula(., fixed.only = TRUE)),
                      AIC = round(model_combinations_q2$AICc, 2),
                      Delta_AIC = round(model_combinations_q2$delta, 2)) %>% 
  as.data.frame(row.names = NULL) 

# Create a table in R Markdown format
kable(model_tableq2, row.names = FALSE)

compare_performance(get.models(model_combinations_q2, subset = 1:10)) 
```
