---
title: "Linear mixed models"
author: "Annegreet Veeken"
date: "`r Sys.Date()`"
output:
  word_document: default
params: 
  data: "outputs/02_GlobNut_subsampled.rds"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, fig.height=4, fig.width=4, message=FALSE, warning=FALSE)

## Load packages
if(!require(tidyverse)) install.packages("tidyverse")
if(!require(vegan)) install.packages("vegan")
if(!require(performance)) install.packages("performance")
if(!require(parameters)) install.packages("parameters")
if(!require(ggeffects)) install.packages("ggeffects")
if(!require(lme4)) install.packages("lme4")
if(!require(knitr)) install.packages("knitr")
if(!require(insight)) install.packages("insight")
if(!require(partR2)) install.packages("partr2")
if(!require(scales)) install.packages("scales")
if(!require(cowplot)) install.packages("cowplot")
if(!require(gridExtra)) install.packages("gridExtra")

## Load data
globnut <- readRDS(params$data) %>% ungroup() %>% 
  mutate(soil_age = factor(soil_age, levels = c("1", "2", "3")),
         lith_simp = factor(lith_simp, levels = c("acid", "intermediate",
                                                  "well-buffered")))  %>% 
  mutate(N_biomass = N * biomass,
         P_biomass = P * biomass,
         ndep = log(ndep)) %>% 
  filter(biomass > 10) %>% 
  drop_na()

n_boot <- 10

# formula for predictors
pred <- "MAT + I(MAT^2)  + MAP + PET + ndep + soil_age + lith_simp + elev + (1|cell)"
# batches for partitioning of r2
batch <- list(clim = c("MAT", "MAP", "I(MAT^2)", "PET"),
               geo = c("soil_age", "lith_simp"),
               ndep = "ndep")
colours <- brewer_pal(palette = "GnBu")(5) %>% rev()
names(colours) <- c("clim", "geo", "ndep", "random", "unexplained")
```


```{r fig.height=8, fig.width=7, include=FALSE}
full_model_biomass <- lmer(formula(paste("log(biomass) ~", pred)), data = globnut)
windows();check_model(full_model_biomass)

check_heteroscedasticity(full_model_biomass)
check_outliers(full_model_biomass)

globnut %>% mutate(resi = residuals(full_model_biomass)) %>% view
```

```{r eval=FALSE, include=FALSE}
ggpredict(full_model_biomass, terms = "MAT [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_biomass, terms = "MAP [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_biomass, terms = "ndep [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_biomass, terms = "soil_age [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_biomass, terms = "lith_simp") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)

```


```{r include=FALSE}
biomass_limits <- c(0, 550) 

(biomass_mat <- ggpredict(full_model_biomass, terms = "MAT [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("biomass (g/m2)",limits = biomass_limits) +
  xlab("MAT (°C)") +  
  theme_bw())
(biomass_map <- ggpredict(full_model_biomass, terms = "MAP [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("biomass (g/m2)",limits = biomass_limits) +
  xlab("MAP (mm/yr)") +  
  theme_bw())
(biomass_pet <- ggpredict(full_model_biomass, terms = "PET [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("biomass (g/m2)",limits = biomass_limits) +
  xlab("PET (mm/yr)") +  
  theme_bw())
(biomass_age <- ggpredict(full_model_biomass, terms = "soil_age [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                  linewidth = 0.5, width = 0.1,
                  position = position_dodge(0.5)) +
    geom_point(shape = 21, size = 2, position = position_dodge(0.5),
               fill = colours["geo"]) +
  scale_y_continuous("biomass (g/m2)",limits = biomass_limits) +
  xlab("soil age") +  
  theme_bw())
(biomass_lith <- ggpredict(full_model_biomass, terms = "lith_simp [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                  linewidth = 0.5, width = 0.1,
                  position = position_dodge(0.5)) +
    geom_point(shape = 21, size = 2, position = position_dodge(0.5),
               fill = colours["geo"]) +
  scale_y_continuous("biomass (g/m2)",limits = biomass_limits) +
   scale_x_discrete("Soil parent material", labels = c("acid" = "acid",
                                                      "intermediate" = "inter",
                                                      "calcareous" = "calc",
                                                      "mafic" = "mafic")) +
  theme_bw())
(biomass_ndep <- ggpredict(full_model_biomass, terms = "ndep [all]") %>% 
  ggplot(aes(x = exp(x), y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["ndep"]) +
    geom_line(colour = colours["ndep"], linewidth = 1) +
  scale_y_continuous("biomass (g/m2)",limits = biomass_limits) +
  xlab("N-deposition (g/ha)") +  
  theme_bw())

```

```{r echo=FALSE, fig.height=5, fig.width=5}
r2_biomass <- r2(full_model_biomass)

res <- partR2(full_model_biomass, 
              R2_type = "marginal",
              nboot = n_boot, # set t0 1000 for final analysis
              partbatch = batch,
              allow_neg_r2 = TRUE)

part_r2_biomass <- res$R2 %>% 
  filter(term %in% c("geo","ndep","clim")) %>% 
  dplyr::select(term, estimate, CI_lower, CI_upper) %>% 
  add_row(term = c("random", "unexplained"),
          estimate = c(r2_biomass$R2_conditional- r2_biomass$R2_marginal,
                   1 - r2_biomass$R2_conditional)) %>% 
  # filter(!term == "unexplained") %>% 
  mutate(ymax = cumsum(estimate),
         ymin = lag(ymax, default = 0)) 


```



```{r fig.height=7, fig.width=7, include=FALSE}
full_model_N <- lmer(formula(paste("log(N_biomass) ~", pred)),
                     data = globnut)
check_model(full_model_N)

check_heteroscedasticity(full_model_N)
check_outliers(full_model_N)
```

```{r eval=FALSE, include=FALSE}
ggpredict(full_model_N, terms = "MAT [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_N, terms = "MAP [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_N, terms = "ndep [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_N, terms = "soil_age [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_N, terms = "lith_simp") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
```

```{r include=FALSE}
n_limits <- c(0, 800) 

(n_mat <- ggpredict(full_model_N, terms = "MAT [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("N (g/m2)",limits = n_limits) +
  xlab("MAT (°C)") +  
  theme_bw())
(n_map <- ggpredict(full_model_N, terms = "MAP [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("N (g/m2)",limits = n_limits) +
  xlab("MAP (mm/yr)") +  
  theme_bw())
(n_pet <- ggpredict(full_model_N, terms = "PET [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("N (g/m2)",limits = n_limits) +
  xlab("PET (mm/yr)") +  
  theme_bw())
(n_age <- ggpredict(full_model_N, terms = "soil_age [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                  linewidth = 0.5, width = 0.1,
                  position = position_dodge(0.5)) +
    geom_point(shape = 21, size = 2, position = position_dodge(0.5),
               fill = colours["geo"]) +
  scale_y_continuous("N (g/m2)",limits = n_limits) +
  xlab("soil age") +  
  theme_bw())
(n_lith <- ggpredict(full_model_N, terms = "lith_simp [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                  linewidth = 0.5, width = 0.1,
                  position = position_dodge(0.5)) +
    geom_point(shape = 21, size = 2, position = position_dodge(0.5),
               fill = colours["geo"]) +
  scale_y_continuous("N (g/m2)",limits = n_limits) +
  scale_x_discrete("Soil parent material", labels = c("acid" = "acid",
                                                      "intermediate" = "inter",
                                                      "calcareous" = "calc",
                                                      "mafic" = "mafic")) +
  theme_bw())
(n_ndep <- ggpredict(full_model_N, terms = "ndep [all]") %>% 
  ggplot(aes(x = exp(x), y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["ndep"]) +
    geom_line(colour = colours["ndep"], linewidth = 1) +
  scale_y_continuous("N (g/m2)",limits = n_limits) +
  xlab("N-deposition (g/ha)") +  
  theme_bw())

```

```{r echo=FALSE, fig.height=5, fig.width=5}
r2_n <- r2(full_model_N)
res <- partR2(full_model_N, 
              R2_type = "marginal",
              nboot = n_boot, # set t0 1000 for final analysis
              partbatch = batch,
              allow_neg_r2 = TRUE)

part_r2_n <- res$R2 %>% 
  filter(term %in% c("geo","ndep","clim")) %>% 
  dplyr::select(term, estimate, CI_lower, CI_upper) %>% 
  add_row(term = c("random", "unexplained"),
          estimate = c(r2_n$R2_conditional- r2_n$R2_marginal,
                   1 - r2_n$R2_conditional)) %>% 
  # filter(!term == "unexplained") %>% 
  mutate(ymax = cumsum(estimate),
         ymin = lag(ymax, default = 0)) 
```


```{r fig.height=8, fig.width=7, include=FALSE}
full_model_P <- lmer(formula(paste("log(P_biomass) ~", pred)), data = globnut)
check_model(full_model_P)

check_heteroscedasticity(full_model_P)
check_outliers(full_model_P)
```


```{r eval=FALSE, include=FALSE}
ggpredict(full_model_P, terms = "MAT [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_P, terms = "MAP [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_P, terms = "ndep [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_P, terms = "soil_age [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_P, terms = "lith_simp") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
```


```{r include=FALSE}
p_limits <- c(0, 80) 

(p_mat <- ggpredict(full_model_P, terms = "MAT [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("P (g/m2)",limits = p_limits) +
  xlab("MAT (°C)") +  
  theme_bw())
(p_map <- ggpredict(full_model_P, terms = "MAP [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("P (g/m2)",limits = p_limits) +
  xlab("MAP (mm/yr)") +  
  theme_bw())
(p_pet <- ggpredict(full_model_P, terms = "PET [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("P (g/m2)",limits = p_limits) +
  xlab("PET (mm/yr)") +  
  theme_bw())
(p_age <- ggpredict(full_model_P, terms = "soil_age [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                  linewidth = 0.5, width = 0.1,
                  position = position_dodge(0.5)) +
    geom_point(shape = 21, size = 2, position = position_dodge(0.5),
               fill = colours["geo"]) +
  scale_y_continuous("P (g/m2)",limits = p_limits) +
  xlab("soil age") +  
  theme_bw())
(p_lith <- ggpredict(full_model_P, terms = "lith_simp [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                  linewidth = 0.5, width = 0.1,
                  position = position_dodge(0.5)) +
    geom_point(shape = 21, size = 2, position = position_dodge(0.5),
               fill = colours["geo"]) +
  scale_y_continuous("P (g/m2)",limits = p_limits) +
  scale_x_discrete("Soil parent material", labels = c("acid" = "acid",
                                                      "intermediate" = "inter",
                                                      "calcareous" = "calc",
                                                      "mafic" = "mafic")) +
  theme_bw())
(p_ndep <- ggpredict(full_model_P, terms = "ndep [all]") %>% 
  ggplot(aes(x = exp(x), y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["ndep"]) +
    geom_line(colour = colours["ndep"], linewidth = 1) +
  scale_y_continuous("P (g/m2)",limits = p_limits) +
  xlab("N-deposition (g/ha)") +  
  theme_bw())

```

```{r echo=FALSE, fig.height=5, fig.width=5}
r2_p <- r2(full_model_P)

res <- partR2(full_model_P, 
              R2_type = "marginal",
              nboot = n_boot, # set t0 1000 for final analysis
              partbatch = batch,
              allow_neg_r2 = TRUE)

part_r2_p <- res$R2 %>% 
  filter(term %in% c("geo","ndep","clim")) %>% 
  dplyr::select(term, estimate, CI_lower, CI_upper) %>% 
  add_row(term = c("random", "unexplained"),
          estimate = c(r2_p$R2_conditional- r2_p$R2_marginal,
                   1 - r2_p$R2_conditional)) %>% 
  # filter(!term == "unexplained") %>% 
  mutate(ymax = cumsum(estimate),
         ymin = lag(ymax, default = 0)) 


```


```{r fig.height=8, fig.width=7, include=FALSE}
full_model_NP <- lmer(formula(paste("log(NP) ~", pred)), data = globnut)
check_model(full_model_NP)
# summary(full_model_NP)
check_heteroscedasticity(full_model_NP)
check_outliers(full_model_NP)
```

```{r include=FALSE}
np_limits <- c(6, 25) 

(np_mat <- ggpredict(full_model_NP, terms = "MAT [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("N:P",limits = np_limits) +
  xlab("MAT (°C)") +  
  theme_bw())
(np_map <- ggpredict(full_model_NP, terms = "MAP [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("N:P",limits = np_limits) +
  xlab("MAP (mm/yr)") +  
  theme_bw())
(np_pet <- ggpredict(full_model_NP, terms = "PET [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["clim"]) +
    geom_line(colour = colours["clim"], linewidth = 1) +
  scale_y_continuous("N:P",limits = np_limits) +
  xlab("PET (mm/yr)") +  
  theme_bw())
(np_age <- ggpredict(full_model_NP, terms = "soil_age [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                  linewidth = 0.5, width = 0.1,
                  position = position_dodge(0.5)) +
    geom_point(shape = 21, size = 2, position = position_dodge(0.5),
               fill = colours["geo"]) +
  scale_y_continuous("N:P",limits = np_limits) +
  xlab("soil age") +  
  theme_bw())
(np_lith <- ggpredict(full_model_NP, terms = "lith_simp [all]") %>% 
  ggplot(aes(x = x, y = predicted)) +
    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                  linewidth = 0.5, width = 0.1,
                  position = position_dodge(0.5)) +
    geom_point(shape = 21, size = 2, position = position_dodge(0.5),
               fill = colours["geo"]) +
  scale_y_continuous("N:P",limits = np_limits) +
  scale_x_discrete("Soil parent material", labels = c("acid" = "acid",
                                                      "intermediate" = "inter",
                                                      "calcareous" = "calc",
                                                      "mafic" = "mafic")) +
  theme_bw())
(np_ndep <- ggpredict(full_model_NP, terms = "ndep [all]") %>% 
  ggplot(aes(x = exp(x), y = predicted)) +
    geom_ribbon( aes(ymin = conf.low, ymax = conf.high), alpha = .5,
                 fill = colours["ndep"]) +
    geom_line(colour = colours["ndep"], linewidth = 1) +
  scale_y_continuous("N:P",limits = np_limits) +
  xlab("N-deposition (g/ha)") +  
  theme_bw())
```

```{r echo=FALSE, fig.height=5, fig.width=5}
r2_np <- r2(full_model_NP)
res <- partR2(full_model_NP, 
              R2_type = "marginal",
              nboot = n_boot, # set t0 1000 for final analysis
              partbatch = batch,
              allow_neg_r2 = TRUE)

part_r2_np <- res$R2 %>% 
  filter(term %in% c("geo","ndep","clim")) %>% 
  dplyr::select(term, estimate, CI_lower, CI_upper) %>% 
  add_row(term = c("random", "unexplained"),
          estimate = c(r2_np$R2_conditional- r2_np$R2_marginal,
                   1 - r2_np$R2_conditional)) %>% 
  # filter(!term == "unexplained") %>% 
  mutate(ymax = cumsum(estimate),
         ymin = lag(ymax, default = 0)) 

```

```{r eval=FALSE, include=FALSE}
nutr <- bind_rows(list(N = part_r2_n,
                  P = part_r2_p,
                  NP = part_r2_np), .id = "nutrient")
nutr %>% 
  filter(term %in% c("geo","ndep","clim")) %>%
  mutate(nutrient = factor(nutrient, levels = c("N","P","NP"))) %>% 
  ggplot(aes(x = nutrient, y = estimate, fill = term)) + 
    geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper), 
                  linewidth = 0.5, width = 0.1,
                  position = position_dodge(0.5)) +
    geom_point(shape = 21, size = 2, position = position_dodge(0.5)) +
  geom_hline(yintercept = 0, linetype= "dotted") +
  scale_y_continuous("Semi-partial R2") +
  scale_x_discrete("") + 
  theme_bw()
```

## Partial effect plots
```{r echo=FALSE, fig.height=7, fig.width=7}
biomass_mat_grid  <- biomass_mat + theme(axis.title.x = element_blank())
biomass_map_grid  <- biomass_map + theme(axis.title = element_blank())
biomass_pet_grid  <- biomass_pet + theme(axis.title = element_blank())
biomass_age_grid  <- biomass_age + theme(axis.title.x = element_blank())
biomass_lith_grid  <- biomass_lith + theme(axis.title = element_blank())
biomass_ndep_grid  <- biomass_ndep + theme(axis.title = element_blank())

n_mat_grid  <- n_mat + theme(axis.title.x = element_blank())
n_map_grid  <- n_map + theme(axis.title = element_blank())
n_pet_grid  <- n_pet + theme(axis.title = element_blank())
n_age_grid  <- n_age + theme(axis.title.x = element_blank())
n_lith_grid  <- n_lith + theme(axis.title = element_blank())
n_ndep_grid  <- n_ndep + theme(axis.title = element_blank())

p_mat_grid  <- p_mat + theme(axis.title.x = element_blank())
p_map_grid  <- p_map + theme(axis.title = element_blank())
p_pet_grid  <- p_pet + theme(axis.title = element_blank())
p_age_grid  <- p_age + theme(axis.title.x = element_blank())
p_lith_grid  <- p_lith + theme(axis.title = element_blank())
p_ndep_grid  <- p_ndep + theme(axis.title = element_blank())

np_mat_grid  <- np_mat
np_map_grid  <- np_map + theme(axis.title.y = element_blank())
np_pet_grid  <- np_pet + theme(axis.title.y = element_blank())
np_age_grid  <- np_age 
np_lith_grid  <- np_lith + theme(axis.title.y = element_blank())
np_ndep_grid  <- np_ndep + theme(axis.title.y = element_blank())


clim <- grid.arrange(biomass_mat_grid, biomass_map_grid, biomass_pet_grid,
             n_mat_grid, n_map_grid, n_pet_grid,
             p_mat_grid, p_map_grid, p_pet_grid,
             np_mat_grid, np_map_grid, np_pet_grid)
geo_ndep <- grid.arrange(biomass_age_grid, biomass_lith_grid, biomass_ndep_grid,
             n_age_grid,n_lith_grid,n_ndep_grid,
             p_age_grid,p_lith_grid,p_ndep_grid,
             np_age_grid,np_lith_grid,np_ndep_grid)
ggsave("figures/fig1a_lmm.png", clim,
       width = 174, height = 247, units = "mm", dpi = 600)
ggsave("figures/fig1b_lmm.png", geo_ndep,
       width = 174, height = 247, units = "mm", dpi = 600)
```

## Variation explained plots
```{r}
bio <- part_r2_biomass %>% 
  ggplot(aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=term)) +
  geom_rect(col = "black") +
  coord_polar(theta="y") +
  geom_text(x = 2, y = 2, label = paste("Biomass\n","Conditional R2 =\n",
                                        round(r2_biomass$R2_conditional, 
                                              digits = 2))) +
  scale_fill_manual(values = colours) +
  xlim(c(2, 4)) +
  theme_void() +
    theme(legend.position = "bottom",
        legend.title = element_blank()) 
leg <- get_legend(bio)
bio <- bio +
  theme(legend.position = "none")
n <- part_r2_n %>% 
  ggplot(aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=term)) +
  geom_rect(col = "black") +
  coord_polar(theta="y") +
  geom_text(x = 2, y = 2, label = paste("N\n","Conditional R2 =\n",
                                        round(r2_n$R2_conditional, 
                                              digits = 2))) +
  scale_fill_manual(values = colours) +
  xlim(c(2, 4)) +
  theme_void() +
  theme(legend.position = "none")
p <- part_r2_p %>% 
  ggplot(aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=term)) +
  geom_rect(col = "black") +
  coord_polar(theta="y") +
  geom_text(x = 2, y = 2, label = paste("P\n","Conditional R2 =\n",
                                        round(r2_p$R2_conditional, 
                                              digits = 2))) +
  scale_fill_manual(values = colours) +
  xlim(c(2, 4)) +
  theme_void() +
  theme(legend.position = "none")
np <- part_r2_np %>% 
  ggplot(aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=term)) +
  geom_rect(col = "black") +
  coord_polar(theta="y") +
  geom_text(x = 2, y = 2, label = paste("N:P\n","Conditional R2 =\n",
                                        round(r2_np$R2_conditional, 
                                              digits = 2))) +
  scale_fill_manual(values = colours) +
  xlim(c(2, 4)) +
  theme_void() +
  theme(legend.position = "none")

var_plots <- grid.arrange(bio,n,p,np,leg,  ncol = 2, nrow = 3, layout_matrix = rbind(c(1,2),
                                                                        c(3,4),
                                                                        c(5,5)),
             heights = c(2,2,0.5))
ggsave("figures/fig2_varplots.png", var_plots,
       width = 174, height = 247, units = "mm", dpi = 600)
```


## Model outputs
```{r echo=FALSE}
model_parameters(full_model_biomass) %>% 
  mutate(across(where(is.numeric), ~round(., digits = 4))) %>% 
  mutate(Parameter = str_remove(Parameter, "lith_simp")) %>% 
  as_tibble() %>% 
  dplyr::select(-t,-df_error,-Group,-CI) %>% 
  kable(caption = "Model output biomass")
kable(r2_biomass)

model_parameters(full_model_N) %>% 
  mutate(across(where(is.numeric), ~round(., digits = 4))) %>% 
  mutate(Parameter = str_remove(Parameter, "lith_simp")) %>% 
  as_tibble() %>% 
  dplyr::select(-t,-df_error,-Group,-CI) %>% 
  kable(caption = "Model output nitrogen")
kable(r2_n)

model_parameters(full_model_P) %>% 
  mutate(across(where(is.numeric), ~round(., digits = 4))) %>% 
  mutate(Parameter = str_remove(Parameter, "lith_simp")) %>% 
  as_tibble() %>% 
  dplyr::select(-t,-df_error,-Group, -CI) %>% 
  kable(caption = "Model output phosphorus")
kable(r2_p)

model_parameters(full_model_NP) %>%
  mutate(across(where(is.numeric), ~round(., digits = 4))) %>%
  mutate(Parameter = str_remove(Parameter, "lith_simp")) %>%
  as_tibble() %>%
  dplyr::select(-t,-df_error,-Group,-CI) %>%
  kable(caption = "Model output N:P")
kable(r2_np)
```