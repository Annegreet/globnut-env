---
title: "Biomass species compositon"
author: "Annegreet Veeken"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.height=7,
                      fig.width=7,
                      message=FALSE, warning=FALSE)

## Load packages
if(!require(tidyverse)) install.packages("tidyverse")
if(!require(lme4)) install.packages("lme4")
if(!require(performance)) install.packages("performance")
if(!require(parameters)) install.packages("parameters")
if(!require(ggeffects)) install.packages("ggeffects")
if(!require(multcompView)) install.packages("multcompView")
if(!require(MASS)) install.packages("MASS")
if(!require(knitr)) install.packages("knitr")

## Load data
globnut <- readRDS("outputs/01_GlobNut_subsampled.rds")
globnut <- globnut %>%
  mutate(lim = factor(lim, levels = c("No limitation by N, P, K", 
                                      "N-limitation",
                                      "P-limitation",
                                      "Co-limitation N-P"),
                      labels = c("No limitation by N, P, K", 
                                      "N limitation",
                                      "P limitation",
                                      "Colimitation N:P") ))
```

## Differences in biomass and species richness between nutrient limitation

We tested for differences in biomass between nutrient limitation using ANOVA and tukey HSD test.

```{r biomass ~ lim}
av <- aov(biomass ~ lim, data = globnut)
tuk <- TukeyHSD(av,"lim")
let <- multcompView::multcompLetters4(av,tuk)
let <- data_frame(lim = names(let$lim$Letters), sig_let = let$lim$Letters)
sig_lab <- globnut %>% 
  group_by(lim) %>% 
  summarise(mean = mean(biomass), sd = sd(biomass),
            n_obs = n()) %>% 
  left_join(let, by = "lim")

ggplot(globnut, aes(x = lim, y = biomass)) +
  geom_boxplot(fill = NA, width = 0.2) +
  geom_violin(alpha = 0.3) +
  geom_text(data = sig_lab, aes(x = lim, y = mean , label = sig_let)) +
  scale_x_discrete("") +
  scale_y_continuous("Biomass (g/m2)") +
  theme_bw()

```

```{r spec ric ~ lim }
av <- aov(spec_ric ~ lim, data = globnut)
tuk <- TukeyHSD(av,"lim")
let <- multcompView::multcompLetters4(av,tuk)
let <- data_frame(lim = names(let$lim$Letters), sig_let = let$lim$Letters)
sig_lab <- globnut %>% 
  group_by(lim) %>% 
  summarise(mean = mean(spec_ric), sd = sd(spec_ric),
            n_obs = n()) %>% 
  left_join(let, by = "lim")

ggplot(globnut, aes(x = lim, y = spec_ric)) +
  geom_boxplot(fill = NA, width = 0.2) +
  geom_violin(alpha = 0.3) +
  geom_text(data = sig_lab, aes(x = lim, y = mean , label = sig_let)) +
  scale_x_discrete("") +
  scale_y_continuous("Species richness") +
  theme_bw()
```

```{r grass cover ~ lim}
av <- aov(grass_cover ~ lim, data = globnut)
tuk <- TukeyHSD(av,"lim")
let <- multcompView::multcompLetters4(av,tuk)
let <- data_frame(lim = names(let$lim$Letters), sig_let = let$lim$Letters)
sig_lab <- globnut %>% 
  group_by(lim) %>% 
  summarise(mean = mean(grass_cover), sd = sd(grass_cover),
            n_obs = n()) %>% 
  left_join(let, by = "lim")

ggplot(globnut, aes(x = lim, y = grass_cover)) +
  geom_boxplot(fill = NA, width = 0.2) +
  geom_violin(alpha = 0.3) +
  geom_text(data = sig_lab, aes(x = lim, y = mean , label = sig_let)) +
  scale_x_discrete("") +
  scale_y_continuous("Grass cover (%)") +
  theme_bw()
```

```{r forb cover ~ lim}
av <- aov(forb_cover ~ lim, data = globnut)
tuk <- TukeyHSD(av,"lim")
let <- multcompView::multcompLetters4(av,tuk)
let <- data_frame(lim = names(let$lim$Letters), sig_let = let$lim$Letters)

sig_lab <- globnut %>% 
  group_by(lim) %>% 
  summarise(mean = mean(forb_cover), sd = sd(forb_cover),
            n_obs = n()) %>% 
  left_join(let, by = "lim")

ggplot(globnut, aes(x = lim, y = forb_cover)) +
  geom_boxplot(fill = NA, width = 0.2) +
  geom_violin(alpha = 0.3) +
  geom_text(data = sig_lab, aes(x = lim, y = mean, 
                                label = sig_let)) +
  scale_x_discrete("") +
  scale_y_continuous("Forb cover (%)") +
  theme_bw()
```
## Species richness \~ Biomass relationship by nutrient limitation

-   Generalised linear model with linear and quadratic terms for biomass, plus their interaction with the nutrient limitations + plot size
-   negative binomial distribution

```{r fig.height=9}
globnut <- globnut %>% 
  mutate(biomass_centered = biomass - mean(biomass))
spec_bio <- glm.nb(spec_ric ~ lim + biomass + I(biomass^2) +
                biomass*lim + I(biomass^2)*lim + plot_size, 
                data = globnut)

check_model(spec_bio)

# test for overdispersion
# library(DHARMa)
# testDispersion(spec_bio, alternative = "greater", plot = TRUE)
```

```{r fig.height=5}
ggpredict(spec_bio, terms = c("biomass", "lim")) %>% 
  plot(.)
ggpredict(spec_bio, terms = c("biomass", "lim")) %>% 
  plot(.,  show_residuals = TRUE) +
  scale_y_continuous(limits = c(0,200)) 
# ggpredict(spec_bio, terms = "plot_size [all]") %>% 
#   plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggplot(globnut, aes(x = biomass, y = spec_ric, 
                    col = plot_size)) +
  geom_point() +
  theme_bw()

glm_coef <- summary(spec_bio)$coefficients %>% 
  as.data.frame() %>% 
  rownames_to_column("parameter") %>% 
  mutate(across(where(is.numeric), ~round(., digits = 3))) %>% 
  mutate(sig = case_when(`Pr(>|z|)` < 0.001 ~ "***",
                         `Pr(>|z|)` < 0.01 ~ "**",
                         `Pr(>|z|)` < 0.05 ~ "*",
                         `Pr(>|z|)` < 0.1 ~ ".",
                         TRUE ~ ""))
kable(glm_coef)

```

R-square = `r r2_kullback(spec_bio) %>% round(digits = 2)`
