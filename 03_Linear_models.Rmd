---
title: "Linear (mixed) models"
author: "Annegreet Veeken"
date: "`r Sys.Date()`"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, fig.height=7, fig.width=7, message=FALSE, warning=FALSE)

## Load packages
if(!require(tidyverse)) install.packages("tidyverse")
if(!require(vegan)) install.packages("vegan")
if(!require(performance)) install.packages("performance")
if(!require(parameters)) install.packages("parameters")
if(!require(ggeffects)) install.packages("ggeffects")
if(!require(lme4)) install.packages("lme4")
if(!require(knitr)) install.packages("knitr")
if(!require(insight)) install.packages("insight")
if(!require(partR2)) install.packages("partr2")

## Load data
globnut <- readRDS("outputs/01_GlobNut_subsampled.rds") %>% ungroup() %>% 
  mutate(soil_age = factor(soil_age, levels = c("1", "2", "3")) %>%
                             relevel(ref = "2"),
         lith_simp = factor(lith_simp, levels = c("acid", "intermediate",
                                                  "calcareous","mafic")))  %>%
  filter(!lith_simp == "mafic") %>% 
  drop_na()

n_boot <- 10
```


## Nutrients and environment (Linear mixed model) 
### N
 lmer(log(N) ~ MAT + I(MAT^2) + MAP + I(MAP^2) +
                       ndep + soil_age + lith_simp + (1|cell),
                     data = globnut)
```{r fig.height=9}
# # nested random effect
# re_nested_N <- lmer(N ~ 1 + (plot_ID|cell),
#                      data = globnut)
# # ranef(re_model_N) # very small - no need to fit nested effect?
# 
# re_N <- lmer(N ~ 1 + (1|cell),
#                      data = globnut)
# ranef(re_N) 

full_model_N <- lmer(log(N) ~ MAT + I(MAT^2) + MAP + I(MAP^2) + 
                       ndep + soil_age + lith_simp + (1|cell),
                     data = globnut)

check_model(full_model_N)

check_heteroscedasticity(full_model_N)
check_outliers(full_model_N)

```


```{r}
ggpredict(full_model_N, terms = "MAT [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_N, terms = "MAP [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)

ggpredict(full_model_N, terms = "ndep [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_N, terms = "soil_age [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_N, terms = "lith_simp") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)

model_parameters(full_model_N) %>% 
  mutate(across(where(is.numeric), ~round(., digits = 4))) %>% 
  kable()
r2_n <- r2(full_model_N)
kable(r2_n)
```

```{r}
bathch <- list(climate = c("MAT", "MAP", "I(MAT^2)","I(MAP^2)"),
               geo = c("soil_age", "lith_simp"),
               anthro = "ndep")
res <- partR2(full_model_N, 
              R2_type = "marginal",
              nboot = n_boot, # set t0 1000 for final analysis
              partbatch = bathch,
              allow_neg_r2 = TRUE)

part_r2_n <- res$R2 %>% 
  filter(term %in% c("geo","anthro","climate")) %>% 
  dplyr::select(term, estimate, CI_lower, CI_upper) %>% 
  add_row(term = c("random", "unexplained"),
          estimate = c(r2_n$R2_conditional- r2_n$R2_marginal,
                   1 - r2_n$R2_conditional)) %>% 
  mutate(ymax = cumsum(estimate),
         ymin = lag(ymax, default = 0))

ggplot(part_r2_n, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=term)) +
  geom_rect() +
  coord_polar(theta="y") +
  xlim(c(-1, 4)) +
  theme_void() 

```

### P

```{r fig.height=9}
full_model_P <- lmer(log(P) ~ MAT + I(MAT^2) + MAP + I(MAP^2) +
                       ndep + soil_age + lith_simp + (1|cell), data = globnut)
check_model(full_model_P)

check_heteroscedasticity(full_model_P)
check_outliers(full_model_P)
```

```{r}
ggpredict(full_model_P, terms = "MAT [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_P, terms = "MAP [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_P, terms = "ndep [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_P, terms = "soil_age [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_P, terms = "lith_simp [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)

model_parameters(full_model_P) %>% 
  mutate(across(where(is.numeric), ~round(., digits = 4))) %>% 
  kable()
r2_p <- r2(full_model_P)
kable(r2_p)
```

```{r}
res <- partR2(full_model_P, 
              R2_type = "marginal",
              nboot = n_boot, # set t0 1000 for final analysis
              partbatch = bathch,
              allow_neg_r2 = TRUE)

part_r2_p <- res$R2 %>% 
  filter(term %in% c("geo","anthro","climate")) %>% 
  dplyr::select(term, estimate, CI_lower, CI_upper) %>% 
  add_row(term = c("random", "unexplained"),
          estimate = c(r2_p$R2_conditional- r2_p$R2_marginal,
                   1 - r2_p$R2_conditional)) %>% 
  mutate(ymax = cumsum(estimate),
         ymin = lag(ymax, default = 0))

ggplot(part_r2_p, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=term)) +
  geom_rect() +
  coord_polar(theta="y") +
  xlim(c(-1, 4)) +
  theme_void() 

```

### NP

```{r fig.height=9}
full_model_NP <- lmer(log(NP) ~ MAT + I(MAT^2) + MAP + I(MAP^2) +
                       ndep + soil_age + lith_simp + (1|cell), data = globnut)
check_model(full_model_NP)
# summary(full_model_NP)
check_heteroscedasticity(full_model_NP)
check_outliers(full_model_NP)
```

```{r fig.height=5}
ggpredict(full_model_NP, terms = "MAT [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_NP, terms = "MAP [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE) 
ggpredict(full_model_NP, terms = "ndep [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_NP, terms = "soil_age [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)
ggpredict(full_model_NP, terms = "lith_simp [all]") %>% 
  plot(., show_residuals =  TRUE, show_residuals_line = TRUE)

model_parameters(full_model_NP) %>% 
  mutate(across(where(is.numeric), ~round(., digits = 4))) %>% 
  kable()
r2_np <- r2(full_model_NP)
kable(r2_np)
```

```{r}
res <- partR2(full_model_NP, 
              R2_type = "marginal",
              nboot = n_boot, # set t0 1000 for final analysis
              partbatch = bathch,
              allow_neg_r2 = TRUE)

part_r2_np <- res$R2 %>% 
  filter(term %in% c("geo","anthro","climate")) %>% 
  dplyr::select(term, estimate, CI_lower, CI_upper) %>% 
  add_row(term = c("random", "unexplained"),
          estimate = c(r2_np$R2_conditional- r2_np$R2_marginal,
                   1 - r2_np$R2_conditional)) %>% 
  mutate(ymax = cumsum(estimate),
         ymin = lag(ymax, default = 0))

ggplot(part_r2_np, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, fill=term)) +
  geom_rect() +
  coord_polar(theta="y") +
  xlim(c(-1, 4)) +
  theme_void() 
```

```{r}
nutr <- bind_rows(list(N = part_r2_n,
                  P = part_r2_p,
                  NP = part_r2_np), .id = "nutrient")
nutr %>% 
  filter(term %in% c("geo","anthro","climate")) %>%
  mutate(nutrient = factor(nutrient, levels = c("N","P","NP"))) %>% 
  ggplot(aes(x = nutrient, y = estimate, fill = term)) + 
    geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper), 
                  linewidth = 0.5, width = 0.1,
                  position = position_dodge(0.5)) +
    geom_point(shape = 21, size = 2, position = position_dodge(0.5)) +
  geom_hline(yintercept = 0, linetype= "dotted") +
  scale_y_continuous("Semi-partial R2") +
  scale_x_discrete("") + 
  theme_bw()
```

